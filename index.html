<!Doctype html>
<script>
  //  discuss at: http://phpjs.org/functions/pack/
  // original by: Tim de Koning (http://www.kingsquare.nl)
  //    parts by: Jonas Raoni Soares Silva (http://www.jsfromhell.com)
  // bugfixed by: Tim de Koning (http://www.kingsquare.nl)
  //        note: Float encoding by: Jonas Raoni Soares Silva
  //        note: Home: http://www.kingsquare.nl/blog/12-12-2009/13507444
  //        note: Feedback: phpjs-pack@kingsquare.nl
  //        note: 'machine dependent byte order and size' aren't
  //        note: applicable for JavaScript; pack works as on a 32bit,
  //        note: little endian machine
  //   example 1: pack('nvc*', 0x1234, 0x5678, 65, 66);
  //   returns 1: '4xVAB'
  //   example 2: pack('H4', '2345')
  //   returns 2: '#E'
  //   example 3: pack('H*', 'D5')
  //   returns 3: 'Õ'
  //   example 4: pack('d', -100.876)
  //   returns 4: "\u0000\u0000\u0000\u0000\u00008YÀ"
function pack(a){for(var h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,b=0,c=1,d="",e="",f=0,g=[];b<a.length;){for(h=a.charAt(b),i="",b++;b<a.length&&null!==a.charAt(b).match(/[\d\*]/);)i+=a.charAt(b),b++;switch(""===i&&(i="1"),h){case"a":case"A":if("undefined"==typeof arguments[c])throw new Error("Warning:  pack() Type "+h+": not enough arguments");for(e=String(arguments[c]),"*"===i&&(i=e.length),f=0;i>f;f++)d+="undefined"==typeof e[f]?"a"===h?String.fromCharCode(0):" ":e[f];c++;break;case"h":case"H":if("undefined"==typeof arguments[c])throw new Error("Warning: pack() Type "+h+": not enough arguments");if(e=arguments[c],"*"===i&&(i=e.length),i>e.length)throw new Error("Warning: pack() Type "+h+": not enough characters in string");for(f=0;i>f;f+=2)j=e[f],j+=f+1>=i||"undefined"==typeof e[f+1]?"0":e[f+1],"h"===h&&(j=j[1]+j[0]),d+=String.fromCharCode(parseInt(j,16));c++;break;case"c":case"C":if("*"===i&&(i=arguments.length-c),i>arguments.length-c)throw new Error("Warning:  pack() Type "+h+": too few arguments");for(f=0;i>f;f++)d+=String.fromCharCode(arguments[c]),c++;break;case"s":case"S":case"v":if("*"===i&&(i=arguments.length-c),i>arguments.length-c)throw new Error("Warning:  pack() Type "+h+": too few arguments");for(f=0;i>f;f++)d+=String.fromCharCode(255&arguments[c]),d+=String.fromCharCode(arguments[c]>>8&255),c++;break;case"n":if("*"===i&&(i=arguments.length-c),i>arguments.length-c)throw new Error("Warning: pack() Type "+h+": too few arguments");for(f=0;i>f;f++)d+=String.fromCharCode(arguments[c]>>8&255),d+=String.fromCharCode(255&arguments[c]),c++;break;case"i":case"I":case"l":case"L":case"V":if("*"===i&&(i=arguments.length-c),i>arguments.length-c)throw new Error("Warning:  pack() Type "+h+": too few arguments");for(f=0;i>f;f++)d+=String.fromCharCode(255&arguments[c]),d+=String.fromCharCode(arguments[c]>>8&255),d+=String.fromCharCode(arguments[c]>>16&255),d+=String.fromCharCode(arguments[c]>>24&255),c++;break;case"N":if("*"===i&&(i=arguments.length-c),i>arguments.length-c)throw new Error("Warning:  pack() Type "+h+": too few arguments");for(f=0;i>f;f++)d+=String.fromCharCode(arguments[c]>>24&255),d+=String.fromCharCode(arguments[c]>>16&255),d+=String.fromCharCode(arguments[c]>>8&255),d+=String.fromCharCode(255&arguments[c]),c++;break;case"f":case"d":if(k=23,l=8,"d"===h&&(k=52,l=11),"*"===i&&(i=arguments.length-c),i>arguments.length-c)throw new Error("Warning:  pack() Type "+h+": too few arguments");for(f=0;i>f;f++){for(e=arguments[c],n=Math.pow(2,l-1)-1,o=-n+1,p=n,q=o-k,r=isNaN(w=parseFloat(e))||w===-(1/0)||w===+(1/0)?w:0,s=0,t=2*n+1+k+3,u=new Array(t),v=(w=0!==r?0:w)<0,w=Math.abs(w),x=Math.floor(w),y=w-x,C=t;C;)u[--C]=0;for(C=n+2;x&&C;)u[--C]=x%2,x=Math.floor(x/2);for(C=n+1;y>0&&C;--y)u[++C]=((y*=2)>=1)-0;for(C=-1;++C<t&&!u[C];);if(u[(z=k-1+(C=(s=n+1-C)>=o&&p>=s?C+1:n+1-(s=o-1)))+1]){if(!(A=u[z]))for(B=z+2;!A&&t>B;A=u[B++]);for(B=z+1;A&&--B>=0;(u[B]=!u[B]-0)&&(A=0));}for(C=0>C-2?-1:C-3;++C<t&&!u[C];);for((s=n+1-C)>=o&&p>=s?++C:o>s&&(C=n+1-(s=o-1)),(x||0!==r)&&(s=p+1,C=n+2,r===-(1/0)?v=1:isNaN(r)&&(u[C]=1)),w=Math.abs(s+n),D="",B=l+1;--B;)D=w%2+D,w=w>>=1;for(w=0,B=0,C=(D=(v?"1":"0")+D+u.slice(C,C+k).join("")).length,g=[];C;)w+=(1<<B)*D.charAt(--C),7===B&&(g[g.length]=String.fromCharCode(w),w=0),B=(B+1)%8;g[g.length]=w?String.fromCharCode(w):"",d+=g.join(""),c++}break;case"x":if("*"===i)throw new Error("Warning: pack(): Type x: '*' ignored");for(f=0;i>f;f++)d+=String.fromCharCode(0);break;case"X":if("*"===i)throw new Error("Warning: pack(): Type X: '*' ignored");for(f=0;i>f;f++){if(0===d.length)throw new Error("Warning: pack(): Type X: outside of string");d=d.substring(0,d.length-1)}break;case"@":if("*"===i)throw new Error("Warning: pack(): Type X: '*' ignored");if(i>d.length)for(m=i-d.length,f=0;m>f;f++)d+=String.fromCharCode(0);i<d.length&&(d=d.substring(0,i));break;default:throw new Error("Warning:  pack() Type "+h+": unknown format code")}}if(c<arguments.length)throw new Error("Warning: pack(): "+(arguments.length-c)+" arguments unused");return d}
</script>
<script>
  // http://kevin.vanzonneveld.net
  // +   original by: Tim de Koning (http://www.kingsquare.nl)
  // +      parts by: Jonas Raoni Soares Silva - http://www.jsfromhell.com
  // +      parts by: Joshua Bell - http://cautionsingularityahead.blogspot.nl/
  // +
  // +   bugfixed by: marcuswestin
  // %        note 1: Float decoding by: Jonas Raoni Soares Silva
  // %        note 2: Home: http://www.kingsquare.nl/blog/22-12-2009/13650536
  // %        note 3: Feedback: phpjs-unpack@kingsquare.nl
  // %        note 4: 'machine dependant byte order and size' aren't
  // %        note 5: applicable for JavaScript unpack works as on a 32bit,
  // %        note 6: little endian machine
  // *     example 1: unpack('d', "\u0000\u0000\u0000\u0000\u00008YÀ");
  // *     returns 1: { "": -100.875 }
function unpack(a,b){for(var c=0,d=0,e={},f="",g="",h="",i="",j=0,k=0,l="",m=0,n=0,o=0,p=function(a,b,c){for(var d=[],e=a.length;e;e-=1)for(var f=a[e-1],g=8;g;g-=1)d.push(f%2?1:0),f>>=1;d.reverse();var h=d.join(""),i=(1<<b-1)-1,j=parseInt(h.substring(0,1),2)?-1:1,k=parseInt(h.substring(1,1+b),2),l=parseInt(h.substring(1+b),2);return k===(1<<b)-1?0!==l?NaN:j*(1/0):k>0?j*Math.pow(2,k-i)*(1+l/Math.pow(2,c)):0!==l?j*Math.pow(2,-(i-1))*(l/Math.pow(2,c)):0*j};c<a.length;){for(f=a.charAt(c),g="",c++;c<a.length&&null!==a.charAt(c).match(/[\d\*]/);)g+=a.charAt(c),c++;for(""===g&&(g="1"),h="";c<a.length&&"/"!==a.charAt(c);)h+=a.charAt(c),c++;switch("/"===a.charAt(c)&&c++,f){case"a":case"A":g="*"===g?b.length-d:parseInt(g,10),i=b.substr(d,g),d+=g,"a"===f?currentResult=i.replace(/\0+$/,""):currentResult=i.replace(/ +$/,""),e[h]=currentResult;break;case"h":case"H":if(g="*"===g?b.length-d:parseInt(g,10),i=b.substr(d,g),d+=g,g>i.length)throw new Error("Warning: unpack(): Type "+f+": not enough input, need "+g);for(currentResult="",j=0;j<i.length;j++)l=i.charCodeAt(j).toString(16),"h"===f&&(l=l[1]+l[0]),currentResult+=l;e[h]=currentResult;break;case"c":case"C":for(g="*"===g?b.length-d:parseInt(g,10),i=b.substr(d,g),d+=g,j=0;j<i.length;j++)currentResult=i.charCodeAt(j),"c"===f&&currentResult>=128&&(currentResult-=256),e[h+(g>1?j+1:"")]=currentResult;break;case"S":case"s":case"v":for(g="*"===g?(b.length-d)/2:parseInt(g,10),i=b.substr(d,2*g),d+=2*g,j=0;j<i.length;j+=2)currentResult=((255&i.charCodeAt(j+1))<<8)+(255&i.charCodeAt(j)),"s"===f&&currentResult>=32768&&(currentResult-=65536),e[h+(g>1?j/2+1:"")]=currentResult;break;case"n":for(g="*"===g?(b.length-d)/2:parseInt(g,10),i=b.substr(d,2*g),d+=2*g,j=0;j<i.length;j+=2)currentResult=((255&i.charCodeAt(j))<<8)+(255&i.charCodeAt(j+1)),e[h+(g>1?j/2+1:"")]=currentResult;break;case"i":case"I":case"l":case"L":case"V":for(g="*"===g?(b.length-d)/4:parseInt(g,10),i=b.substr(d,4*g),d+=4*g,j=0;j<i.length;j+=4)currentResult=((255&i.charCodeAt(j+3))<<24)+((255&i.charCodeAt(j+2))<<16)+((255&i.charCodeAt(j+1))<<8)+(255&i.charCodeAt(j)),e[h+(g>1?j/4+1:"")]=currentResult;break;case"N":for(g="*"===g?(b.length-d)/4:parseInt(g,10),i=b.substr(d,4*g),d+=4*g,j=0;j<i.length;j+=4)currentResult=((255&i.charCodeAt(j))<<24)+((255&i.charCodeAt(j+1))<<16)+((255&i.charCodeAt(j+2))<<8)+(255&i.charCodeAt(j+3)),e[h+(g>1?j/4+1:"")]=currentResult;break;case"f":case"d":for(n=8,m="f"===f?23:52,o=4,"d"===f&&(n=11,o=8),g="*"===g?(b.length-d)/o:parseInt(g,10),i=b.substr(d,g*o),d+=g*o,j=0;j<i.length;j+=o){for(b=i.substr(j,o),bytes=[],k=b.length-1;k>=0;--k)bytes.push(b.charCodeAt(k));e[h+(g>1?j/4+1:"")]=p(bytes,n,m)}break;case"x":case"X":case"@":g="*"===g?b.length-d:parseInt(g,10),g>0&&("X"===f?d-=g:"x"===f?d+=g:d=g);break;default:throw new Error("Warning:  unpack() Type "+f+": unknown format code")}}return e}
</script>
<script>
function fread(handle,length){
	var data = handle.data.slice(handle.pos,handle.pos+length);
	handle.pos = handle.pos+length;
	return data;
}
function fwrite(handle,buffer,length){
	handle.data = handle.data + buffer.slice(0, length);
	handle.pos = handle.pos+length;
	return handle.pos;
}

function getInt32(handle){
	var str = fread(handle,4);
	var buf = pack('a4',str);
	var res = unpack('l',buf);
	return(res[1]||res[""]);
}
function getInt8(handle){
	var str = fread(handle,1);
	var buf = pack('a',str);
	var res = unpack('c',buf);
	return(res[1]||res[""]);
}
function getString(handle,length){
	var str =  fread(handle,length);
	var buf = pack('a'+length,str);
	var res = unpack('a'+length,buf);
	return(res[1]||res[""]);
}
function getFloat(handle){
	var str = fread(handle, 4);
	var buf = pack('a4',str);
	var res = unpack('f',buf);
	return(res[1]||res[""]);
}

function writeInt32(handle,val){
	var buf = pack('l',val);
	return fwrite(handle, buf,4);
}
function writeInt8(handle,val){
	var buf = pack('c',val);
	return fwrite(handle, buf,1);
}
function writeFloat(handle,val){
	buf = pack('f',val);
	return fwrite(handle, buf,4);
}
function writeString(handle,val,length){
	var buf = pack('a'+length,val);
	return fwrite(handle, buf,length);
}


</script>
<style>
  #byte_content {
    margin: 5px 0;
    max-height: 100px;
    overflow-y: auto;
    overflow-x: hidden;
  }
  #byte_range { margin-top: 5px; }
  #drop_zone {
    border: 2px dashed #bbb;
    border-radius: 5px;
    padding: 25px;
    text-align: center;
    font: 20pt bold 'Vollkorn';
    color: #bbb;
}
p>label{
	display:inline-block;
	font-weight:bold;
	width: 30%;
}
p>label:after{
	content:': ';
}
#previewArea>canvas{
	max-width:512px;
	max-height:512px;
	position:absolute;
	top:0;
	left:0;
}
#previewArea.hideHeightMap>#highmap{
	display:none;
}
#previewArea.hideTexture>#texture{
	display:none;
}
#previewArea.hideWater>#water{
	display:none;
}
#previewArea.hideCliff>#cliff{
	display:none;
}
#previewArea.hideObjects>#objects{
	display:none;
}
#previewArea.hideStartPos>#startpos{
	display:none;
}


#previewArea>#control{
	position:absolute;
	bottom: -20px;
	height:20px;
}
#previewArea>#control>button:before{
	content:'Hide ';
}
#previewArea.hideHeightMap>#control>button.hideHeightMap:before,
#previewArea.hideTexture>#control>button.hideTexture:before,
#previewArea.hideWater>#control>button.hideWater:before,
#previewArea.hideCliff>#control>button.hideCliff:before,
#previewArea.hideObjects>#control>button.hideObjects:before,
#previewArea.hideStartPos>#control>button.hideStartPos:before
{
	content:'Show ';
}
</style>
<div id="drop_zone">Drop map or png file here <input type="file" id="files" name="file" style="display:none;"/></div>
<div id="previewArea" style="width:512px;height:512px;padding:0;margin:0;border:none;display:inline-block;position:relative;">
	<canvas id="highmap"></canvas>
	<canvas id="texture"></canvas>
	<canvas id="water"></canvas>
	<canvas id="cliff"></canvas>
	<canvas id="objects"></canvas>
	<canvas id="startpos"></canvas>
	<div id="control">
		<button class="hideHeightMap" onclick="togglePreviewArea('hideHeightMap')">Heights</button>
		<button class="hideTexture" onclick="togglePreviewArea('hideTexture')">Surfaces</button>
		<button class="hideWater" onclick="togglePreviewArea('hideWater')">Water</button>
		<button class="hideCliff" onclick="togglePreviewArea('hideCliff')">Cliffs</button>
		<button class="hideObjects" onclick="togglePreviewArea('hideObjects')">Objects</button>
		<button class="hideStartPos" onclick="togglePreviewArea('hideStartPos')">Start positions</button>
	</div>
</div>
<div style="width:40%;padding:0;margin:0;border:none;display:inline-block;">
	<p>
		<label for="#version-field">version</label>
		<select name="version-field" id="version-field" disabled>
			<option value="1">1 [Glest format]</option>
			<option value="2">2 [Megaglest format]</option>
		</select>
	</p>
	<p>
		<label for="#maxPlayers-field">maxPlayers</label>
		<select name="maxPlayers-field" id="maxPlayers-field" disabled>
			<option value="1">1</option>
			<option value="2">2</option>
			<option value="3">3</option>
			<option value="4">4</option>
			<option value="5">5</option>
			<option value="6">6</option>
			<option value="7">7</option>
			<option value="8">8</option>
		</select>
	</p>
	<p>
		<label for="#width-field">width</label>
		<select name="width-field" id="width-field" disabled>
			<option value="16">16</option>
			<option value="32">32</option>
			<option value="64">64</option>
			<option value="128">128</option>
			<option value="256">256</option>
			<option value="512">512</option>
		</select>
	</p>
	<p>
		<label for="#height-field">height</label>
		<select name="height-field" id="height-field" disabled>
			<option value="16">16</option>
			<option value="32">32</option>
			<option value="64">64</option>
			<option value="128">128</option>
			<option value="256">256</option>
			<option value="512">512</option>
		</select>
	</p>
	<p><label for="#altFactor-field">altFactor</label><input id="altFactor-field" type="text" readonly> (1.00 - 99.99 lower means more hill effect)</p>
	<p><label for="#waterLevel-field">waterLevel</label>
		<select name="waterLevel-field" id="waterLevel-field" disabled>
			<option value="0">0</option>
			<option value="1">1</option>
			<option value="2">2</option>
			<option value="3">3</option>
			<option value="4">4</option>
			<option value="5">5</option>
			<option value="6">6</option>
			<option value="7">7</option>
			<option value="8">8</option>
			<option value="9">9</option>
			<option value="10">10</option>
			<option value="11">11</option>
			<option value="12">12</option>
			<option value="13">13</option>
			<option value="14">14</option>
			<option value="15">15</option>
			<option value="16">16</option>
			<option value="17">17</option>
			<option value="18">18</option>
			<option value="19">19</option>
			<option value="20">20</option>
		</select>
	</p>
	<p><label for="#title-field">title</label><input id="title-field" type="text" maxlength="128" readonly></p>
	<p><label for="#autor-field">autor</label><input id="autor-field" type="text" maxlength="128" readonly></p>
	<p><label for="#description-field">description</label><textarea name="description-field" id="description-field" cols="64" rows="4"  maxlength="128" readonly></textarea></p>
	<p><label for="#magic-field">magic</label><span id="magic-field"></span></p>
	
	<p><label for="#cliffLevel-field">cliffLevel</label>
		<select name="cliffLevel-field" id="cliffLevel-field" disabled>
			<option value="0">0</option>
			<option value="1">1</option>
			<option value="2">2</option>
			<option value="3">3</option>
			<option value="4">4</option>
			<option value="5">5</option>
			<option value="6">6</option>
			<option value="7">7</option>
			<option value="8">8</option>
			<option value="9">9</option>
			<option value="10">10</option>
			<option value="11">11</option>
			<option value="12">12</option>
			<option value="13">13</option>
			<option value="14">14</option>
			<option value="15">15</option>
			<option value="16">16</option>
			<option value="17">17</option>
			<option value="18">18</option>
			<option value="19">19</option>
			<option value="20">20</option>
		</select>
	</p>
	<p><label for="#cameraHeight-field">cameraHeight</label>
		<select name="cameraHeight-field" id="cameraHeight-field" disabled>
			<option value="0">auto</option>
			<option value="20">20</option>
			<option value="21">21</option>
			<option value="21">21</option>
			<option value="22">22</option>
			<option value="23">23</option>
			<option value="24">24</option>
			<option value="25">25</option>
			<option value="26">26</option>
			<option value="27">27</option>
			<option value="28">28</option>
			<option value="29">29</option>
			<option value="30">30</option>
			<option value="31">31</option>
			<option value="32">32</option>
			<option value="33">33</option>
			<option value="34">34</option>
			<option value="35">35</option>
			<option value="36">36</option>
			<option value="37">37</option>
			<option value="38">38</option>
			<option value="39">39</option>
			<option value="40">40</option>
		</select>
	</p>
	<p><label for="#meta-field">meta</label><span id="meta-field"></span></p>
	<p><a id="btnSaveHeightmap">Save Heightmap</a> <a id="btnSaveMap">Save Map</a> <button onclick="contrastHighmap(10)">increase contrast</button> <button onclick="contrastHighmap(-10)">reduce contrast</button> </p>
	<p><button onclick="randomIsland()">Random island</button> ( requires a map for StartLocation )</p>
</div>
<script>
  function togglePreviewArea(hideClass){
	document.getElementById('previewArea').classList.toggle(hideClass);
  }
  
  function readBlob(file,callback) {

    var reader = new FileReader();
	
    reader.onloadend = function(evt) {
      if (evt.target.readyState == FileReader.DONE) { // DONE == 2
		callback(evt.target.result);
      }
    };
	
    reader.readAsBinaryString(file);
  }
  
function componentToHex(c) {
    var hex = c.toString(16);
    return hex.length == 1 ? "0" + hex : hex;
}

function rgbToHex(r, g, b) {
    return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);
}
  var map = {};
  
  
function getCanvasWithContext(id){
	if(!map.maxPlayers){
		return;
	}
	var renderer = {};
	renderer.canvas = document.getElementById(id);
	renderer.scale = 512 / Math.max(map.width,map.height);
	renderer.canvas.style.width = (map.width * renderer.scale)+'px';
	renderer.canvas.style.height = (map.height * renderer.scale)+'px';
	if (renderer.canvas.getContext) {
		renderer.ctx = renderer.canvas.getContext('2d');
		renderer.renderScaled = function(callback/*({x,y,cell}) => {r,g,b,a}*/){
			renderer.ctx.canvas.width  = map.width*renderer.scale;
			renderer.ctx.canvas.height = map.height*renderer.scale;
			var imgData=renderer.ctx.createImageData(map.width*renderer.scale,map.height*renderer.scale);
			for (var i = 0 ;i < imgData.data.length ; i += 4){
				var cellID = i / 4;
				var cellPos = descale(cellID,renderer.scale);
				var cell = callback({x:cellPos.x,y:cellPos.y,cell:map.map[cellPos.x]&&map.map[cellPos.x][cellPos.y]});
				imgData.data[i+0]=cell.r;
				imgData.data[i+1]=cell.g;
				imgData.data[i+2]=cell.b;
				imgData.data[i+3]=cell.a;
			  }
			renderer.ctx.putImageData(imgData,0,0);	
		}
		renderer.renderObjects = function(callback/*({x,y,cell}) => {r,g,b,a}*/){
			renderer.ctx.canvas.width  = map.width*renderer.scale;
			renderer.ctx.canvas.height = map.height*renderer.scale;
			var imgData=renderer.ctx.createImageData(map.width*renderer.scale,map.height*renderer.scale);
			renderer.ctx.putImageData(imgData,0,0);	
			for (var cellID = 0 ;cellID < map.width*map.height ; cellID += 1){
				var cellPos = descale(cellID,1);
				var padding = Math.floor(renderer.scale / 4);
				var area = {
					x: cellPos.x*renderer.scale+padding,
					y: cellPos.y*renderer.scale+padding,
					w: renderer.scale-(padding*2),
					h: renderer.scale-(padding*2)
				};
				var cell = callback({
					x:cellPos.x,
					y:cellPos.y,
					cell:map.map[cellPos.x]&&map.map[cellPos.x][cellPos.y],
					ctx:renderer.ctx,
					area:area
				});
			  }
		}
		return renderer;
	}
	return false;
}

document.getElementById('btnSaveHeightmap').addEventListener("click", function( event ) {
		var renderer = getCanvasWithContext('highmap');	
		if(!renderer){
			return;
		}
		this.href = renderer.canvas.toDataURL();
		this.download = map.title+'.hmap.png';
	}, false);
document.getElementById('btnSaveMap').addEventListener("click", function( event ) {
		this.href = "data:application/x-megaglest-map;base64," + window.btoa(writeMap());
		this.download = map.title+'.mgm';
	}, false);
  
function renderHeightMap(){
	var renderer = getCanvasWithContext('highmap');	
	if(!renderer){
		return;
	}
	renderer.ctx.canvas.width  = map.width;
	renderer.ctx.canvas.height = map.height;
	
	var imgData=renderer.ctx.createImageData(map.width,map.height);
	for (var i=0;i<imgData.data.length;i+=4)
	  {
		var cellID = i / 4;
		var co = map.map[(cellID % map.width)][(Math.floor(cellID / map.width))]['h'] / 20 * 255;
		imgData.data[i+0]=co;
		imgData.data[i+1]=co;
		imgData.data[i+2]=co;
		imgData.data[i+3]=255;
	  }
	renderer.ctx.putImageData(imgData,0,0);
	
}

var textures = [
	{r:0,g:102,b:0,name:'Grass'},
	{r:51,g:76,b:0,name:'Secondary Grass'},
	{r:76,g:38,b:0,name:'Road'},
	{r:89,g:89,b:89,name:'Stone'},
	{r:89,g:64,b:38,name:'Custom'}
];
function renderSurfaces(){
	var renderer = getCanvasWithContext('texture');	
	if(!renderer){
		return;
	}
	renderer.renderScaled(function(d){ 
		var res ={};
		var tex = textures[d.cell.s-1];
		if(!tex){
			tex = textures[0];
		}
		res.r=tex.r;
		res.g=tex.g;
		res.b=tex.b;
		res.a=200;
		return res;
	});	
}


function checkIsCliff(x,y){
	for(var xi = x - 1;xi < x + 1; xi++){
		if( map.map[x] && map.map[xi]){
			for(var yi = y - 1;yi < y + 1; yi++){
				if(map.map[x][y] && map.map[xi][yi]){
					if(Math.abs( map.map[x][y].h - map.map[xi][yi].h ) >= map.cliffLevel){
						return true;
					}
				}
			}
		}
	}
	return false;
}

function renderCliff(){
	var renderer = getCanvasWithContext('cliff');	
	if(!renderer){
		return;
	}
	renderer.renderScaled(function(d){ 
		var res ={};
		if(!map.cliffLevel || map.cliffLevel == 0){
			res.r=0;
			res.g=0;
			res.b=0;
			res.a=0;
		}else if(checkIsCliff(d.x,d.y)){
			res.r=200;
			res.g=255;
			res.b=0;
			res.a=255;
		}else{
			res.r=0;
			res.g=0;
			res.b=0;
			res.a=0;
		}
		return res;
	});
}

function canvasDrawX(ctx,x,y,w,h,color){
	ctx.beginPath();
	ctx.moveTo(x, y);
	ctx.lineWidth = 1;
	ctx.lineTo(x+w, y+h);
	ctx.closePath();
	ctx.strokeStyle = color;
	ctx.stroke();
	ctx.beginPath();
	ctx.moveTo(x, y + h);
	ctx.lineWidth = 1;
	ctx.lineTo(x+w, y);
	ctx.closePath();
	ctx.strokeStyle = color;
	ctx.stroke();
}

function renderObjects(){
	var renderer = getCanvasWithContext('objects');	
	if(!renderer){
		return;
	}
	renderer.renderObjects(function(d){ 
		if(d.cell.o === 1){
			d.ctx.fillStyle="#FF0000";
			d.ctx.fillRect(d.area.x,d.area.y,d.area.w,d.area.h); 
		}else if(d.cell.o === 2){
			d.ctx.fillStyle="#FFFFFF";
			d.ctx.fillRect(d.area.x,d.area.y,d.area.w,d.area.h); 
		}else if(d.cell.o === 3){
			d.ctx.fillStyle="#9370DB";
			d.ctx.fillRect(d.area.x,d.area.y,d.area.w,d.area.h); 
		}else if(d.cell.o === 4){
			d.ctx.fillStyle="#0000cc";
			d.ctx.fillRect(d.area.x,d.area.y,d.area.w,d.area.h); 
		}else if(d.cell.o === 5){
			d.ctx.fillStyle="#cccccc";
			d.ctx.fillRect(d.area.x,d.area.y,d.area.w,d.area.h); 
		}else if(d.cell.o === 6){
			d.ctx.fillStyle="#FFA500";
			d.ctx.fillRect(d.area.x,d.area.y,d.area.w,d.area.h); 
		}else if(d.cell.o === 7){
			d.ctx.fillStyle="#7fffd4";
			d.ctx.fillRect(d.area.x,d.area.y,d.area.w,d.area.h); 
		}else if(d.cell.o === 8){
			d.ctx.fillStyle="#8b2323";
			d.ctx.fillRect(d.area.x,d.area.y,d.area.w,d.area.h); 
		}else if(d.cell.o === 9){
			d.ctx.fillStyle="#7fff00";
			d.ctx.fillRect(d.area.x,d.area.y,d.area.w,d.area.h); 
		}else if(d.cell.o === 10){
			d.ctx.fillStyle="#ff1493";
			d.ctx.fillRect(d.area.x,d.area.y,d.area.w,d.area.h); 
		}else if(d.cell.o === 11){
			canvasDrawX(d.ctx,d.area.x,d.area.y,d.area.w,d.area.h,'#ffb90f');
		}else if(d.cell.o === 12){
			canvasDrawX(d.ctx,d.area.x,d.area.y,d.area.w,d.area.h,'#bebebe');
		}else if(d.cell.o === 13){
			canvasDrawX(d.ctx,d.area.x,d.area.y,d.area.w,d.area.h,'#cc0000');
		}else if(d.cell.o === 14){
			canvasDrawX(d.ctx,d.area.x,d.area.y,d.area.w,d.area.h,'#0000cc');
		}else if(d.cell.o === 15){
			canvasDrawX(d.ctx,d.area.x,d.area.y,d.area.w,d.area.h,'#008b8b');
		}else if(d.cell.o === 0){
			// do nothing
		}else{
			console.log('Not supported object', d.cell.o);
		}
	});
}


function descale(cellID,scale){
	var dividor = map.width * scale;
	return{
		x : Math.floor((cellID % dividor)/scale),
		y : Math.floor((Math.floor(cellID / dividor))/scale)
	};
}
function renderWater(){
	var renderer = getCanvasWithContext('water');	
	if(!renderer){
		return;
	}
	renderer.renderScaled(function(d){ 
		var res ={};
		
		res.r = 0;
		res.g = 0;
		if(d.cell.h <= map.waterLevel - 1.5){
			res.b = 51;
			res.a = 255;
		}else if(d.cell.h <= map.waterLevel){
			res.b = 51;
			res.a = 86;
		}else{
			res.b = 0;
			res.a = 0;
		}
		return res;
	});
}


var playerColors = [
	rgbToHex(255, 0, 0),
	rgbToHex( 0, 0, 255),
	rgbToHex( 0, 255, 0),
	rgbToHex( 255, 255, 0),
	rgbToHex( 255, 255, 255),
	rgbToHex( 0, 255, 255),
	rgbToHex( 255, 127, 0),
	rgbToHex( 255, 0, 255)
];

function renderStartPos(){
	var renderer = getCanvasWithContext('startpos');	
	if(!renderer){
		return;
	}
	renderer.ctx.canvas.width  = map.width*renderer.scale;
	renderer.ctx.canvas.height = map.height*renderer.scale;
	
	
	map.startLocation.forEach(function(loc,index){
		renderer.ctx.beginPath();
		var x = parseInt(loc.x *renderer.scale+renderer.scale/2);
		var y = parseInt(loc.y *renderer.scale+renderer.scale/2);
		renderer.ctx.moveTo(x -renderer.scale, y-renderer.scale);
		renderer.ctx.lineWidth = 1;
		renderer.ctx.lineTo(x+renderer.scale, y+renderer.scale);
		renderer.ctx.strokeStyle = playerColors[index];
		renderer.ctx.stroke();
		renderer.ctx.beginPath();
		renderer.ctx.moveTo(x +renderer.scale, y-renderer.scale);
		renderer.ctx.lineWidth = 1;
		renderer.ctx.lineTo(x-renderer.scale, y+renderer.scale);
		renderer.ctx.strokeStyle = playerColors[index];
		renderer.ctx.stroke();
	});
}
  
function renderMapToCanvas(){
	if(!map.maxPlayers){
		return;
	}
	document.getElementById('version-field').value = map.version;
	document.getElementById('maxPlayers-field').value = map.maxPlayers;
	document.getElementById('width-field').value = map.width;
	document.getElementById('height-field').value = map.height;
	if(map.altFactor > 100){
		document.getElementById('altFactor-field').value = (map.altFactor / 100);
	}else{
		document.getElementById('altFactor-field').value = map.altFactor;
	}
	document.getElementById('waterLevel-field').value = map.waterLevel;
	document.getElementById('title-field').value = map.title;
	document.getElementById('autor-field').value = map.autor;
	document.getElementById('description-field').value = map.description;
	if(map.version > 1){
		document.getElementById('description-field').maxLength = 128;
		document.getElementById('description-field').rows = 2;
		
		document.getElementById('magic-field').parentElement.style.display = 'block';
		document.getElementById('cliffLevel-field').parentElement.style.display = 'block';
		document.getElementById('cameraHeight-field').parentElement.style.display = 'block';
		document.getElementById('meta-field').parentElement.style.display = 'block';
		
		document.getElementById('magic-field').innerHTML = '0x'+map.magic.toString(16);
		document.getElementById('cliffLevel-field').value = map.cliffLevel;
		if(map.cameraHeight < 20){
			document.getElementById('cameraHeight-field').value = 0;
		}else{
			document.getElementById('cameraHeight-field').value = Math.min(map.cameraHeight,40);
		}
		document.getElementById('meta-field').innerHTML = map.meta;
	}else{
		document.getElementById('description-field').value = 256;
		document.getElementById('description-field').rows = 4;
		
		document.getElementById('magic-field').parentElement.style.display = 'none';
		document.getElementById('cliffLevel-field').parentElement.style.display = 'none';
		document.getElementById('cameraHeight-field').parentElement.style.display = 'none';
		document.getElementById('meta-field').parentElement.style.display = 'none';
	}
	setTimeout(renderHeightMap,1);
	setTimeout(renderSurfaces,1);
	setTimeout(renderCliff,1);
	setTimeout(renderObjects,1);
	setTimeout(renderWater,1);
	setTimeout(renderStartPos,1);	
}
  
  function handleFileSelect(evt) {
    evt.stopPropagation();
    evt.preventDefault();

    var files = (evt.dataTransfer && evt.dataTransfer.files) || document.getElementById('files').files; // FileList object.
	document.getElementById('files').files = files;

    var output = [];
    var f = files[0];
	if(f.name.indexOf('.gbm') === f.name.length - 4 || f.name.indexOf('.mgm')  === f.name.length - 4){
		readBlob(f,function(handleData){
			var handle = {data:handleData,pos:0};
			map = {};
			map.version = getInt32(handle);
			map.maxPlayers = getInt32(handle);
			map.width = getInt32(handle);
			map.height = getInt32(handle);
			map.altFactor = getInt32(handle);
			map.waterLevel = getInt32(handle);
			map.title = getString(handle,128);
			if(!map.title || map.title === ''){
				map.title = f.name.slice(0,f.name.length - 4);
			}
			map.autor = getString(handle,128);
			
			if(map.version <= 1){
				map.description = getString(handle,256);
				map.magic = false;
				map.cliffLevel = false;
				map.cameraHeight = false;
				map.meta = false;
			}else{
				map.description = getString(handle,128);
				map.magic = getInt32(handle);
				map.cliffLevel = getInt32(handle);
				map.cameraHeight = getInt32(handle);
				map.meta = getString(handle,116);
			}
			
			map.startLocation = [];
			for( var i = 0; i < map.maxPlayers;i++){
				map.startLocation[i] = {
					x:getInt32(handle),
					y:getInt32(handle)
				};
			}
			
			map.map  = [];
			for(i = 0; i < ( map.width *  map.height);i++){
				if(!map.map[(i % map.width)]){
					map.map[(i % map.width)] = []; 
				}
				if(!map.map[(i % map.width)][(Math.floor(i / map.width))]){
					map.map[(i % map.width)][(Math.floor(i / map.width))] = {}; 
				}
				map.map[(i % map.width)][(Math.floor(i / map.width))]['h'] = getFloat(handle);
			}
			for(i = 0; i < ( map.width *  map.height);i++){
				if(!map.map[(i % map.width)]){
					map.map[(i % map.width)] = []; 
				}
				if(!map.map[(i % map.width)][(Math.floor(i / map.width))]){
					map.map[(i % map.width)][(Math.floor(i / map.width))] = {}; 
				}
				map.map[(i % map.width)][(Math.floor(i / map.width))]['s'] = getInt8(handle);
			}
			for(i = 0; i < ( map.width *  map.height);i++){
				if(!map.map[(i % map.width)]){
					map.map[(i % map.width)] = []; 
				}
				if(!map.map[(i % map.width)][(Math.floor(i / map.width))]){
					map.map[(i % map.width)][(Math.floor(i / map.width))] = {}; 
				}
				map.map[(i % map.width)][(Math.floor(i / map.width))]['o'] = getInt8(handle);
			}
			
			setTimeout(renderMapToCanvas,1);
			
		});
	}else if(f.name.indexOf('.png') === f.name.length - 4){
		var reader = new FileReader();
		reader.onload = function(event){
			var img = new Image();
			img.onload = function(){
				if(map.width === img.width && map.height === img.height){
					var canvasHighmap = document.getElementById('highmap');
			var scale = 512 / Math.max(map.width,map.height);
			canvasHighmap.style.width = (map.width * scale)+'px';
			canvasHighmap.style.height = (map.height * scale)+'px';
			
			if (canvasHighmap.getContext) {
				var ctx = canvasHighmap.getContext('2d');
				ctx.canvas.width  = map.width;
				ctx.canvas.height = map.height;
				
				ctx.drawImage(img,0,0);
				updateHeightMapFromCanvas();
			}
				}else{
					alert('Sizes do not match');
				}
				
			};
			img.src = event.target.result;
		}
		reader.readAsDataURL(f);  
	}
  }
  
  function contrastHighmap(contrast){
	var canvasHighmap = document.getElementById('highmap');
	if (canvasHighmap.getContext) {
		var ctx = canvasHighmap.getContext('2d');
		var imageData=ctx.getImageData(0,0,map.width,map.height);
		var data = imageData.data;
		var factor = (259 * (contrast + 255)) / (255 * (259 - contrast));

		for(var i=0;i<data.length;i+=4)
		{
			data[i] = factor * (data[i] - 128) + 128;
			data[i+1] = factor * (data[i+1] - 128) + 128;
			data[i+2] = factor * (data[i+2] - 128) + 128;
		}
		ctx.putImageData(imageData,0,0);
		updateHeightMapFromCanvas();
	}
  }
  
  function updateHeightMapFromCanvas(){
		var canvasHighmap = document.getElementById('highmap');			
			if (canvasHighmap.getContext) {
				var ctx = canvasHighmap.getContext('2d');
				var imgData=ctx.getImageData(0,0,map.width,map.height);
				for (var i=0;i<imgData.data.length;i+=4){
					var cellID = i / 4;
					map.map[(cellID % map.width)][(Math.floor(cellID / map.width))]['h'] = (imgData.data[i+0]+imgData.data[i+1]+imgData.data[i+2] )/ 3 * 20 / 255;
				}
				console.log(map);
				setTimeout(renderMapToCanvas,1);
			}
  };
  
	function writeMap(){
		var handle = {data:"",pos:0};
		if(!map.maxPlayers){
			return;
		}
		
		writeInt32(handle,map.version);
		writeInt32(handle,map.maxPlayers);
		writeInt32(handle,map.width);
		writeInt32(handle,map.height);
		writeInt32(handle,map.altFactor);
		writeInt32(handle,map.waterLevel);
		writeString(handle,map.title,128);
		writeString(handle,map.autor,128);
		if(map.version <= 1){
			writeString(handle,map.description,256);
		}else{
			writeString(handle,map.description,128);
			writeInt32(handle,map.magic);
			writeInt32(handle,map.cliffLevel);
			writeInt32(handle,map.cameraHeight);
			writeString(handle,map.meta,116);
		}
		for(var i = 0; i < map.maxPlayers;i++){
			var loc = map.startLocation[i];
			if(loc && loc.x > -1 && loc.y > -1){
				writeInt32(handle,loc.x);
				writeInt32(handle,loc.y);
			}else{
				writeInt32(handle,0);
				writeInt32(handle,0);
			}
		}
		for(i = 0; i < ( map.width *  map.height);i++){
			if(!map.map[(i % map.width)]){
				map.map[(i % map.width)] = []; 
			}
			if(!map.map[(i % map.width)][(Math.floor(i / map.width))]){
				map.map[(i % map.width)][(Math.floor(i / map.width))] = {}; 
			}
			writeFloat(handle,map.map[(i % map.width)][(Math.floor(i / map.width))]['h']);
		}
		for(i = 0; i < ( map.width *  map.height);i++){
			if(!map.map[(i % map.width)]){
				map.map[(i % map.width)] = []; 
			}
			if(!map.map[(i % map.width)][(Math.floor(i / map.width))]){
				map.map[(i % map.width)][(Math.floor(i / map.width))] = {}; 
			}
			writeInt8(handle,map.map[(i % map.width)][(Math.floor(i / map.width))]['s']);
		}
		for(i = 0; i < ( map.width *  map.height);i++){
			if(!map.map[(i % map.width)]){
				map.map[(i % map.width)] = []; 
			}
			if(!map.map[(i % map.width)][(Math.floor(i / map.width))]){
				map.map[(i % map.width)][(Math.floor(i / map.width))] = {}; 
			}
			writeInt8(handle,map.map[(i % map.width)][(Math.floor(i / map.width))]['o']);
		}
		
		
		return handle.data;
	};

function closeCells(x,y,type){
	var cells = 0;
	for(var j=y-1;j<=y+1;j++){
		for(var i=x-1;i<=x+1;i++){
			if(map.map[i] && map.map[i][j] && map.map[i][j].type == type && !(i==y && j==x)){
				cells++;
			}else if((!map.map[i] ||!map.map[i][j]) && !(i==y && j==x)){/*makes island*/
				cells++;
			}
		}
	}
	return cells;
}	

var changes = 1;
//var rule = {'water':[5,6]};
var rule = {'water':[5,6]};

function next(){
	if(changes <= 0){
		//fillOcean();
		map.startLocation.forEach(ensureStatpointLand);
		return;
	}
	changes = 0;
	for(var x=0;x<map.width;x++){
		for(var y=0;y<map.height;y++){
			var waterCells = closeCells(x,y,'water');
			if(waterCells < rule['water'][0] && map.map[x][y].type != 'land'){
				map.map[x][y].type = 'land';
				changes++;
			}else if(waterCells > rule['water'][1] && map.map[x][y].type == 'land'){
				map.map[x][y].type = 'water';
				changes++;
			}
			if(map.map[x][y].type === 'water'){
				map.map[x][y].h = Math.random()*(map.waterLevel - 1.5);
			}else if(map.cliffLevel){
				map.map[x][y].h = map.waterLevel + Math.random()*(map.cliffLevel);
			}else{
				map.map[x][y].h = map.waterLevel + Math.random()*(20-map.waterLevel);
			}
		}
	}
	map.startLocation.forEach(ensureStatpointLand);
	setTimeout(renderMapToCanvas,1);
	setTimeout(next,1);
}

function ensureStatpointLand(loc,index){
	var size = 8;
	var resourceMargin = 2;
	var offsetX = 0;
	var offsetY = 0;
	
	if(loc.x-size < 0){
		offsetX = 0-(loc.x-size);
	}
	if(loc.x+size >= map.width){
		offsetX = 0-(loc.x+size+1-map.width);
	}
	if(loc.y-size < 0){
		offsetY = 0-(loc.y-size);
	}
	if(loc.y+size >= map.height){
		offsetY = 0-(loc.y+size+1-map.height);
	}
	
	loc.x = loc.x + offsetX;
	loc.y = loc.y + offsetY;
	
	console.log(loc.x,loc.y,map.map[loc.x][loc.y],offsetX,offsetY);
	for(var i = loc.x - size; i <= loc.x + size; i++){
		for(var j = loc.y - size; j <= loc.y + size; j++){
			if(!map.map[i] || !map.map[i][j]){
				console.log('loc',loc.x,loc.y,'offset',offsetX,offsetY,'i',i,'j',j,map.map[i]);
			}
			map.map[i][j].type = 'land';
			map.map[i][j].h = 10;
			if(map.cliffLevel > 0){
				map.map[i][j].h = map.waterLevel + (map.cliffLevel/2);
			}
			map.map[i][j].s = 3;
			if(i === loc.x - size || i === loc.x + size || j === loc.y - size || j === loc.y + size){
				map.map[i][j].s = 2;
			}
		}
	}
	for(var i = loc.x - size+resourceMargin; i <= loc.x - resourceMargin; i++){
		for(var j = loc.y - size+resourceMargin; j <= loc.y -resourceMargin; j++){
			if(-i-j > -loc.x - loc.y + size){
				map.map[i][j].o = 11;
			}
		}
	}
	for(var i = loc.x + resourceMargin; i <= loc.x +size-resourceMargin; i++){
		for(var j = loc.y + resourceMargin; j <= loc.y + size-resourceMargin; j++){
			if(i+j > loc.x + loc.y + size){
				map.map[i][j].o = 12;
			}
		}
	}
	for(var i = loc.x + resourceMargin; i <= loc.x +size-resourceMargin; i++){
		for(var j = loc.y - size+resourceMargin; j <= loc.y -resourceMargin; j++){
			if(i-j > loc.x - loc.y + size){
				map.map[i][j].o = 1;
			}
		}
	}
	for(var i = loc.x - size+resourceMargin; i <= loc.x - resourceMargin; i++){
		for(var j = loc.y + resourceMargin; j <= loc.y + size-resourceMargin; j++){
			if(-i+j > -loc.x + loc.y + size){
				map.map[i][j].o = 2;
			}
		}
	}
	
	
}

function randomIsland(){
	if(map.width <= 0 || map.height <= 0||map.maxPlayer < 1||!map.startLocation){
		return;
	}
	map.map = [];
	map.title = 'generaded_'+Math.random();
	map.author = 'http://muwns.eu/mgm/';
	for(var i=0;i<map.width;i++){
		map.map[i] = [];
		for(var j=0;j<map.height;j++){
			map.map[i][j] = {};
			map.map[i][j].type = (Math.random()<0.4)?'land':'water';
			if(i==0||j==0||i==map.width-1||j==map.height-1){
				map.map[i][j].type = 'water';
			}
			if(map.map[i][j].type === 'water'){
				map.map[i][j].h = 0;
			}else{
				map.map[i][j].h = 10;
			}
			map.map[i][j].s = 1;
			map.map[i][j].o = 0;
		}
	}
	map.startLocation.forEach(ensureStatpointLand);
	
	changes = 1;
	
	
	setTimeout(renderMapToCanvas,1);
	setTimeout(next,1);
	
}

  function handleDragOver(evt) {
    evt.stopPropagation();
    evt.preventDefault();
	evt.dataTransfer.dropEffect = 'copy';
  }

var dropZone = document;
  dropZone.addEventListener('dragover', handleDragOver, false);
  dropZone.addEventListener('drop', handleFileSelect, false);
</script>